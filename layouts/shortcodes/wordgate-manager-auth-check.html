<!-- WordGate ç®¡ç†å‘˜æƒé™æ£€æŸ¥ç»„ä»¶ -->
<div id="manager-auth-check" style="display: none;">
  <!-- æƒé™æ£€æŸ¥é€šè¿‡åæ˜¾ç¤ºçš„å†…å®¹ -->
  <div class="manager-authorized">
    {{ .Inner }}
  </div>
</div>

<!-- æƒé™ä¸è¶³æç¤º -->
<div id="manager-unauthorized" style="display: none; text-align: center; padding: 3rem;">
  <div style="font-size: 4rem; margin-bottom: 2rem;">ğŸ”’</div>
  <h2 style="color: #dc3545; margin-bottom: 1rem;">è®¿é—®å—é™</h2>
  <p style="color: #6c757d; margin-bottom: 2rem;">æ‚¨éœ€è¦ç®¡ç†å‘˜æƒé™æ‰èƒ½è®¿é—®æ­¤é¡µé¢</p>
  <div>
    <a href="/wordgate/login" class="btn btn-primary" style="margin-right: 1rem;">ç™»å½•</a>
    <a href="/" class="btn" style="color: #6c757d; text-decoration: none;">è¿”å›é¦–é¡µ</a>
  </div>
</div>

<script>
(function() {
  'use strict';
  
  function checkManagerAuth() {
    const authCheck = document.getElementById('manager-auth-check');
    const unauthorized = document.getElementById('manager-unauthorized');
    
    if (!authCheck || !unauthorized) {
      console.error('Manager auth check elements not found');
      return;
    }
    
    // ç­‰å¾… WordGate SDK åŠ è½½
    function waitForWordGate() {
      if (!window.$wg) {
        setTimeout(waitForWordGate, 100);
        return;
      }
      
      performAuthCheck();
    }
    
    function performAuthCheck() {
      try {
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²ç™»å½•
        if (!window.$wg.auth.isLoggedIn()) {
          console.log('[Manager Auth] ç”¨æˆ·æœªç™»å½•');
          showUnauthorized('è¯·å…ˆç™»å½•ä»¥è®¿é—®ç®¡ç†é¡µé¢');
          return;
        }
        
        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰ç®¡ç†å‘˜æƒé™
        if (!window.$wg.user.hasManagerRole()) {
          console.log('[Manager Auth] ç”¨æˆ·æ— ç®¡ç†å‘˜æƒé™');
          showUnauthorized('æ‚¨æ²¡æœ‰ç®¡ç†å‘˜æƒé™');
          return;
        }
        
        // æƒé™æ£€æŸ¥é€šè¿‡
        console.log('[Manager Auth] æƒé™æ£€æŸ¥é€šè¿‡');
        showAuthorized();
        
      } catch (error) {
        console.error('[Manager Auth] æƒé™æ£€æŸ¥å¤±è´¥:', error);
        showUnauthorized('æƒé™æ£€æŸ¥å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢é‡è¯•');
      }
    }
    
    function showAuthorized() {
      authCheck.style.display = 'block';
      unauthorized.style.display = 'none';
      
      // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶æƒé™æ£€æŸ¥é€šè¿‡
      const event = new CustomEvent('wordgate:manager-auth-success', {
        bubbles: true,
        detail: { authorized: true }
      });
      document.dispatchEvent(event);
    }
    
    function showUnauthorized(message) {
      authCheck.style.display = 'none';
      unauthorized.style.display = 'block';
      
      // æ›´æ–°é”™è¯¯æ¶ˆæ¯
      const errorMsg = unauthorized.querySelector('p');
      if (errorMsg && message) {
        errorMsg.textContent = message;
      }
      
      // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶ï¼Œé€šçŸ¥å…¶ä»–ç»„ä»¶æƒé™æ£€æŸ¥å¤±è´¥
      const event = new CustomEvent('wordgate:manager-auth-failed', {
        bubbles: true,
        detail: { authorized: false, message: message }
      });
      document.dispatchEvent(event);
    }
    
    // å¼€å§‹æƒé™æ£€æŸ¥
    waitForWordGate();
  }
  
  // DOM åŠ è½½å®Œæˆåæ‰§è¡Œæƒé™æ£€æŸ¥
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', checkManagerAuth);
  } else {
    checkManagerAuth();
  }
  
  // ç›‘å¬ç™»å½•çŠ¶æ€å˜åŒ–
  document.addEventListener('wordgate:auth-changed', function(event) {
    console.log('[Manager Auth] ç™»å½•çŠ¶æ€å˜åŒ–:', event.detail);
    setTimeout(checkManagerAuth, 100); // å»¶è¿Ÿæ£€æŸ¥ï¼Œç¡®ä¿ç”¨æˆ·ä¿¡æ¯å·²æ›´æ–°
  });
  
})();
</script>