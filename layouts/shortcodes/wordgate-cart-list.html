{{/* WordGateè´­ç‰©è½¦åˆ—è¡¨çŸ­ä»£ç  */}}

<div id="wg-cart-list" 
     x-data="cartListComponent()"
     x-init="init()"
     x-cloak>
     
  <div class="wordgate-container wordgate-cart-container">
    <!-- åŠ è½½ä¸­çŠ¶æ€ -->
    <div class="cart-loading" x-show="loading">
      <div class="spinner"></div>
    </div>
    
    <!-- è´­ç‰©è½¦ä¸ºç©º -->
    <div class="cart-empty" x-show="!loading && items.length === 0">
      <p>{{ i18n "cart_empty" | default "è´­ç‰©è½¦æ˜¯ç©ºçš„" }}</p>
      <a href="/" class="pure-button pure-button-primary">{{ i18n "browse_courses" | default "è¿”å›é¦–é¡µ" }}</a>
    </div>
    
    <!-- è´­ç‰©è½¦å†…å®¹ -->
    <div class="cart-items" x-show="!loading && !error && items.length > 0">
      <div class="cart-items-list">
        <template x-for="item in items" :key="item.code">
          <div class="cart-item">
            <div class="cart-item-image">
              <img x-bind:src="item.image || '/images/placeholder.png'" x-bind:alt="item.title">
            </div>
            <div class="cart-item-info">
              <h3 class="cart-item-title" x-text="item.title"></h3>
              <div class="cart-item-price" :class="'money-usd'" x-text="formatPrice(item.price)"></div>
              <div class="cart-item-address-note" x-show="item.require_address">
                <small class="address-required">ğŸ  éœ€è¦æ”¶è´§åœ°å€</small>
              </div>
            </div>
            <div class="cart-item-quantity">
              <button class="quantity-btn" x-on:click="updateQuantity(item.code, Math.max(1, item.quantity - 1))">-</button>
              <input type="number" x-model.number="item.quantity" min="1" x-on:change="updateQuantity(item.code, item.quantity)">
              <button class="quantity-btn" x-on:click="updateQuantity(item.code, item.quantity + 1)">+</button>
            </div>
            <div class="cart-item-subtotal" :class="'money-usd'" x-text="formatPrice(item.price * item.quantity)"></div>
            <button class="cart-item-remove" x-on:click="removeItem(item.code)">&times;</button>
          </div>
        </template>
      </div>
      
      <!-- åœ°å€é€‰æ‹©åŒºåŸŸ -->
      <div class="address-selection" x-show="requireAddress">
        {{ partial "wordgate-address-list.html" (dict "mode" "select" "required" true) }}
      </div>
      
      <!-- è®¢å•é”™è¯¯ä¿¡æ¯ -->
      <div class="cart-error" x-show="orderError" x-text="orderError"></div>
      
      <!-- è´­ç‰©è½¦æ±‡æ€» -->
      <div class="cart-summary">
        <div class="summary-row">
          <span>{{ i18n "subtotal" | default "å°è®¡" }}:</span>
          <span :class="'money-usd'" x-text="formatPrice(totalPrice)"></span>
        </div>
        <div class="summary-row total">
          <span>{{ i18n "total" | default "æ€»è®¡" }}:</span>
          <span :class="'money-usd'" x-text="formatPrice(totalPrice)"></span>
        </div>
        <div class="cart-actions">
          <button class="pure-button" x-on:click="clearCart" :disabled="isCreatingOrder">
            {{ i18n "clear_cart" | default "æ¸…ç©ºè´­ç‰©è½¦" }}
          </button>
          <button class="pure-button pure-button-primary" x-on:click="checkout" :disabled="isCreatingOrder || (requireAddress && !selectedAddressId)">
            <span x-show="!isCreatingOrder">{{ i18n "checkout" | default "ç»“ç®—" }}</span>
            <span x-show="isCreatingOrder">å¤„ç†ä¸­...</span>
          </button>
        </div>
      </div>
    </div>
    
    <!-- è´­ç‰©è½¦é”™è¯¯ä¿¡æ¯ -->
    <div class="cart-error" x-show="error" x-text="error"></div>
    
    <!-- ç™»å½•æ¨¡æ€æ¡† -->
    <div class="wordgate-modal" x-ref="loginModal" style="display: none;">
      <div class="wordgate-modal-content">
        <span class="wordgate-close" x-on:click="closeModal('loginModal')">&times;</span>
        <h2>{{ i18n "login_required" | default "è¯·å…ˆç™»å½•" }}</h2>
        <p>{{ i18n "login_to_checkout" | default "æ‚¨éœ€è¦å…ˆç™»å½•æ‰èƒ½å®Œæˆè´­ä¹°ã€‚" }}</p>
        <button class="pure-button pure-button-primary" x-on:click="goToLogin">{{ i18n "login" | default "ç™»å½•" }}</button>
      </div>
    </div>
  </div>
</div>

<script>
  // è´­ç‰©è½¦åˆ—è¡¨ç»„ä»¶
  window.cartListComponent = function() {
    return {
      items: [],
      loading: false,
      error: null,
      totalPrice: 0,
      isCreatingOrder: false,
      orderError: null,
      selectedAddressId: null,
      requireAddress: false,
      selectedAddress: null,
      
      init() {
        // åˆå§‹åŒ–æ¸…ç†å‡½æ•°æ•°ç»„
        this.cleanupFunctions = [];
        
        this.items = $wg.cart.getItems();
        this.calculateTotal();
        this.checkRequireAddress();
        
        // ç›‘å¬è´­ç‰©è½¦å˜åŒ–
        const cartUnsubscribe = $wg.cart.onChanged((items) => {
          this.items = items;
          this.calculateTotal();
          this.checkRequireAddress();
        });
        this.cleanupFunctions.push(cartUnsubscribe);
        
        // ç›‘å¬åœ°å€é€‰æ‹©å™¨å˜åŒ–
        const addressPickerUnsubscribe = $wg.address_picker.onChanged((address) => {
          this.selectedAddress = address;
          this.selectedAddressId = address ? address.id : null;
          console.log('[Cart] åœ°å€é€‰æ‹©å˜åŒ–:', address);
        });
        this.cleanupFunctions.push(addressPickerUnsubscribe);
        
        // é¡µé¢å¸è½½æ—¶æ¸…ç†
        const handleBeforeUnload = () => {
          this.cleanup();
        };
        window.addEventListener('beforeunload', handleBeforeUnload);
        this.cleanupFunctions.push(() => {
          window.removeEventListener('beforeunload', handleBeforeUnload);
        });
      },
      
      cleanup() {
        // æ¸…ç†æ‰€æœ‰ç›‘å¬å™¨
        if (this.cleanupFunctions) {
          this.cleanupFunctions.forEach(cleanup => {
            if (typeof cleanup === 'function') {
              cleanup();
            }
          });
          this.cleanupFunctions = [];
        }
      },
      
      checkRequireAddress() {
        this.requireAddress = this.items.some(item => item.require_address);
      },
      
      removeItem(itemCode) {
        $wg.cart.removeItem(itemCode);
      },
      
      updateQuantity(itemCode, quantity) {
        $wg.cart.updateQuantity(itemCode, parseInt(quantity));
      },
      
      calculateTotal() {
        this.totalPrice = $wg.cart.getTotalPrice();
      },
      
      clearCart() {
        $wg.cart.clear();
      },

      async checkout() {
        if (!$wg.auth.isLoggedIn()) {
          window.location.href = '/login?redirect=/cart/';
          return;
        }
        
        // æ£€æŸ¥æ˜¯å¦éœ€è¦åœ°å€ä½†æœªé€‰æ‹©
        if (this.requireAddress && !this.selectedAddressId) {
          this.orderError = 'è¯·é€‰æ‹©æ”¶è´§åœ°å€';
          return;
        }
        
        try {
          this.isCreatingOrder = true;
          this.orderError = null;
          
          // æ ¼å¼åŒ–è´­ç‰©è½¦å•†å“ä¸ºAPIéœ€è¦çš„æ ¼å¼
          const formattedItems = this.items.map(item => ({
            item_code: item.code,
            quantity: item.quantity,
            item_type: item.item_type || undefined // å¯é€‰å­—æ®µï¼Œä¸å­˜åœ¨æ—¶ä¸ä¼ é€’
          }));
          
          // åˆ›å»ºè®¢å•
          const orderData = {
            items: formattedItems
          };
          
          // å¦‚æœéœ€è¦åœ°å€ï¼Œæ·»åŠ åœ°å€ID
          if (this.requireAddress && this.selectedAddressId) {
            orderData.address_id = this.selectedAddressId;
          }
          
          const {data} = await $wg.with('orders').createProduct(orderData);
          
          // æ¸…ç©ºè´­ç‰©è½¦
          $wg.cart.clear();
          
          // è·³è½¬åˆ°æ”¯ä»˜é¡µé¢
          if (data && data.pay_url) {
            window.location.href = data.pay_url;
          } else {
            this.orderError = 'åˆ›å»ºè®¢å•æˆåŠŸä½†è·å–æ”¯ä»˜é“¾æ¥å¤±è´¥';
          }
        } catch (error) {
          console.error('[Cart] åˆ›å»ºè®¢å•å¤±è´¥:', error);
          
          // å¤„ç†ç‰¹å®šé”™è¯¯
          if (error.code === 401) {
            // ç™»å½•çŠ¶æ€å¤±æ•ˆï¼ŒSDKä¼šè‡ªåŠ¨æ¸…é™¤token
            window.location.href = '/login?redirect=/cart/';
          } else if (error.code === 422) {
            this.orderError = error.message || 'è®¢å•æ•°æ®ä¸æ­£ç¡®';
          } else {
            this.orderError = error.message || 'åˆ›å»ºè®¢å•å¤±è´¥';
          }
          this.isCreatingOrder = false;
        }
      },
      
      formatPrice(price) {
        return $wg.helper.formatMoney(price, 'USD');
      },
      
      closeModal(modalId) {
        this.$refs[modalId].style.display = 'none';
      },
      
      goToLogin() {
        window.location.href = '/login/?redirect=' + encodeURIComponent(window.location.pathname);
      },
      
      goToProfile() {
        window.location.href = '/profile/';
      }
    };
  };
</script>

<style>
  
  .cart-loading, .cart-empty, .cart-error {
    text-align: center;
    padding: 2rem;
    color: #666;
  }
  
  .cart-error, .address-error {
    color: #e53e3e;
    background-color: #fff5f5;
    border: 1px solid #fc8181;
    border-radius: 4px;
    margin: 1rem 0;
    padding: 1rem;
  }
  
  .spinner {
    border: 4px solid #f3f3f3;
    border-top: 4px solid #3498db;
    border-radius: 50%;
    width: 30px;
    height: 30px;
    margin: 0 auto;
    animation: spin 1s linear infinite;
  }
  
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  
  .cart-item {
    display: flex;
    align-items: center;
    padding: 1rem;
    margin-bottom: 1rem;
    border: 1px solid #eee;
    border-radius: 4px;
  }
  
  .cart-item-image {
    width: 80px;
    height: 80px;
    overflow: hidden;
    margin-right: 1rem;
  }
  
  .cart-item-image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .cart-item-info {
    flex: 1;
  }
  
  .cart-item-title {
    margin: 0 0 0.5rem;
    font-size: 1rem;
  }
  
  .cart-item-price {
    color: #666;
    margin-bottom: 0.25rem;
  }
  
  .address-required {
    color: #f6ad55;
    font-style: italic;
  }
  
  .cart-item-quantity {
    display: flex;
    align-items: center;
    margin: 0 1rem;
  }
  
  .cart-item-quantity input {
    width: 40px;
    text-align: center;
    border: 1px solid #ddd;
    border-radius: 0;
    margin: 0 5px;
    padding: 5px;
  }
  
  .quantity-btn {
    border: 1px solid #ddd;
    background: #f8f8f8;
    width: 30px;
    height: 30px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }
  
  .cart-item-subtotal {
    font-weight: bold;
    margin-right: 1rem;
    min-width: 80px;
    text-align: right;
  }
  
  .cart-item-remove {
    border: none;
    background: none;
    font-size: 1.5rem;
    color: #999;
    cursor: pointer;
  }
  
  .cart-summary {
    padding: 1rem;
    border: 1px solid #eee;
    border-radius: 4px;
    margin-top: 1rem;
  }
  
  .summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.5rem;
  }
  
  .summary-row.total {
    font-weight: bold;
    font-size: 1.2rem;
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #eee;
  }
  
  .cart-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 1rem;
  }
  
  /* åœ°å€é€‰æ‹©å®¹å™¨æ ·å¼ */
  .address-selection {
    margin: 2rem 0;
  }
  
  .wordgate-modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }
  
  .wordgate-modal-content {
    background-color: white;
    margin: 15% auto;
    padding: 2rem;
    border-radius: 4px;
    max-width: 500px;
    position: relative;
  }
  
  .wordgate-close {
    position: absolute;
    top: 10px;
    right: 15px;
    font-size: 1.5rem;
    cursor: pointer;
  }
  
  [x-cloak] {
    display: none !important;
  }
</style>
